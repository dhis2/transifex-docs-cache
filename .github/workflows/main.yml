name: Transifex Workflow

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '11 21 * * *'
  workflow_dispatch:

jobs:
  transifex:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@master
            
    - name: Download the CLI
      run: curl -o- https://raw.githubusercontent.com/transifex/cli/master/install.sh | bash -s -- latest
      working-directory: ${{ github.workspace }}
      shell: bash

    - name: Initialize Transifex
      run: |
        ./tx init
      shell: bash
      working-directory: ${{ github.workspace }}

    - name: Add Transifex remotes
      run: |
        ./tx add remote --file-filter 'projects/<project_slug>/<lang>/<resource_slug>.md' --minimum-perc 100 https://app.transifex.com/hisp-uio/docs-full-site/dashboard/
        ./tx add remote --file-filter 'projects/<project_slug>/<lang>/<resource_slug>.md' --minimum-perc 100 https://app.transifex.com/hisp-uio/dhis2-single-page-docs/dashboard/
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        TX_TOKEN: ${{ secrets.TRANSIFEX_DOCS_CACHE_TOKEN }}

    - name: Pull Transifex resources
      run: |
        ./tx pull --all
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        TX_TOKEN: ${{ secrets.TRANSIFEX_DOCS_CACHE_TOKEN }}

    
    - name: Commit & Push changes
      uses: actions-js/push@master
      with:
        directory: website/data/
        branch: master
        github_token: ${{ secrets.DHIS2_BOT_GITHUB_TOKEN }}

